(function(e){e.fn.lattice=function(t){var n=e.extend({},{startSelector:">:first-child",debug:false,speed:1e3,pause:3e3,adjacentEasing:"swing",nonAdjacentEasing:"linear",thumnailMapEnabled:true,thumbnailWidth:15,thumbnailHeight:15,thumbnailSpacing:3,adjacentLinkHideDuration:200,adjacentLinkShowDuration:700,thumbnailMapHideDuration:200,thumbnailMapShowDuration:700,thumbnailActiveClass:"lattice-thumbnail-active",containerClass:"lattice-container",html:{wrapper:'<div class="" style="position:relative;"></div>',thumbnailDefault:'<div class="lattice-thumbnail"></div>',thumbnailEmpty:'<div class"lattice-thumbnail empty"></div>',thumbnailMap:'<div class="lattice-thumbnail-map" style="opacity:0.4;position:absolute;bottom:15px;right:15px"></div>',northArrow:'<div style="left:50%;top:15px;position:absolute;opacity:0.4;width: 0;height:0;border-left:20px solid transparent;border-right: 20px solid transparent;border-bottom: 20px solid rgb(167, 161, 161);"></div>',eastArrow:'<div style="top:50%;right:15px;position:absolute;opacity:0.4;width: 0;height: 0;border-top: 20px solid transparent;border-bottom: 20px solid transparent;border-left: 20px solid rgb(167, 161, 161);"></div>',southArrow:'<div style="left:50%;bottom:15px;position:absolute;opacity:0.4;width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-top:20px solid rgb(167, 161, 161);"></div>',westArrow:'<div style="top:50%;left:15px;position:absolute;opacity:0.4;width: 0;height: 0;border-top: 20px solid transparent;border-bottom: 20px solid transparent; border-right:20px solid rgb(167, 161, 161); "></div>'},sliderWidth:"500px",sliderHeight:"400px",fullScreen:false,dynamicThumbnails:true,grid:[],currentPath:[],active:{row:null,col:null},inMotion:false,compassDict:{north:{offsetR:-1,offsetC:0},south:{offsetR:1,offsetC:0},east:{offsetR:0,offsetC:1},west:{offsetR:0,offsetC:-1}},keyDict:{37:"west",38:"north",39:"east",40:"south"}},t);if(n.pause<=n.speed)n.pause=n.speed+100;return this.each(function(){function l(t,r){e(".lattice-thumbnail-map ."+n.thumbnailActiveClass).toggleClass(n.thumbnailActiveClass);var i=".lattice-thumbnail-map .lattice-grid-link[href=#"+t+"-"+r+"] .lattice-thumbnail";e(i).toggleClass(n.thumbnailActiveClass)}function c(e,t){n.active.row=e;n.active.col=t}function h(){e(".lattice-adjacent-link").hide(n.adjacentLinkHideDuration)}function p(){e(".lattice-adjacent-link").show(n.adjacentLinkShowDuration)}function d(){if(n.fullScreen)return;e(".lattice-thumbnail-map").hide(n.thumbnailMapHideDuration)}function v(){e(".lattice-thumbnail-map").show(n.thumbnailMapShowDuration).css("display","inline")}function m(e,t){if(e.length>1||!e){var r=0,i=n.speed;var s=r==e.length-2;g(e[r],e[r+1],false,s);r++;window.setInterval(function(){if(r+1==e.length){return}if(r==0){i=0}M("Taking slide "+r+" in the "+e[r].directionTaken+" direction.");l(e[r+1].row,e[r+1].col);var t=r>0?e[r-1]:false,n=r==e.length-2;g(e[r],e[r+1],t,n);r++},i)}n.inMotion=false}function g(t,r,i,s){var o=e("[data-row="+t.row+"][data-col="+t.col+"]"),u=e("[data-row="+r.row+"][data-col="+r.col+"]"),a=e("[data-row="+i.row+"][data-col="+i.col+"]");a.removeAttr("style").css({"float":"left","list-style":"none",position:"absolute",height:"100%",width:"100%",display:"none"});animOptions=[{},{},{}],direction=x(t.directionTaken);h();e.each(animOptions,function(e,t){animOptions[e][direction]=0});M(s);M(direction);if(t.directionTaken=="west"||t.directionTaken=="east"){animOptions[0][direction]=o.width();animOptions[1][direction]=-o.width()}else{animOptions[0][direction]=o.height();animOptions[1][direction]=-o.height()}var f=s?n.adjacentEasing:n.nonAdjacentEasing;M(f);o.removeClass("active").animate(animOptions[0],n.speed,f);u.addClass("active").show().css(animOptions[1]).animate(animOptions[2],n.speed,f,function(){if(s){p()}});n.active.col=r.col;n.active.row=r.row}function y(e){var t=new Array(e||0),n=e;if(arguments.length>1){var r=Array.prototype.slice.call(arguments,1);while(n--)t[e-1-n]=createArray.apply(this,r)}return t}function b(t,n){return t.children().map(function(){return parseInt(e(this).data(n))}).get().sort(function(e,t){return t-e})[0]}function w(e,t,n){M("Starting solver.");var r=[];M("Path initialized");if(E(e,t,n,r)!=null){N();M("Found a solution. Returning path.");r.reverse();return r}N();M("Solution not found! Returning null.");return null}function E(e,t,n,r){M("Currently at "+e.row+":"+e.col);if(S(e,t)){M("We've reached the end!");n[e.row][e.col].visited=true;var i=n[e.row][e.col];i.directionTaken="none";r.push(i);return r}var s={north:e.row>t.row,east:e.col<t.col,south:e.row<t.row,west:e.col>t.col};var o={north:e.row-1<0?false:n[e.row-1][e.col],south:e.row+1>=n.length?false:n[e.row+1][e.col],east:e.col+1>=n[0].length?false:n[e.row][e.col+1],west:e.col-1<0?false:n[e.row][e.col-1]};M(s);for(var u in s){if(s[u]&&o[u]){M(o[u]);M("GENERAL BIAS: Checking "+o[u].row+":"+o[u].col+" to the "+u);if(n[e.row][e.col][u]&&o[u]&&!o[u].visited){M("Room is open. Going "+u+".");n[e.row][e.col].visited=true;if(E(o[u],t,n,r)!=null){var i=n[e.row][e.col];i.directionTaken=u;r.push(i);return r}}M("Closed.")}}M(o);for(var u in o){if(o.hasOwnProperty(u)&&o[u]){M(o[u]);M("Checking "+o[u].row+":"+o[u].col+" to the "+u);if(n[e.row][e.col][u]&&o[u]&&!o[u].visited){M("Room is open. Going "+u+".");n[e.row][e.col].visited=true;if(E(o[u],t,n,r)!=null){var i=n[e.row][e.col];i.directionTaken=u;r.push(i);return r}}M("Closed.")}}M("Reached a dead end.");return null}function S(e,t){if(e.row==t.row&&e.col==t.col){return true}return false}function x(e){var t={north:"top",south:"bottom",east:"right",west:"left"};return t[e]}function T(t){return e.extend({},t)}function N(){for(var e=0;e<=n.gridRows;e++){for(var t=0;t<=n.gridCols;t++){n.grid[e][t].visited=false}}}function C(t){e(t).css({width:"100%",height:"100%"});e("."+n.containerClass).css({width:window.innerWidth+"px",height:e(window).height()+"px"})}function k(t,r,i,s){var u="#"+t.attr("id");html2canvas(e(u),{onrendered:function(r,i,u){var a=new Image;a.src=r.toDataURL("image/png");a.style="width:100%;height:100%;";e(s).append(a).appendTo(".lattice-thumbnail-map").css({clear:o,display:"block","float":"left",width:n.thumbnailWidth+"px",height:n.thumbnailHeight+"px",margin:n.thumbnailSpacing+"px"});wrapThumbnailInAnchor(s,t)}})}function L(t,r,i,s){e(r).appendTo(".lattice-thumbnail-map").css({clear:i,display:"block","float":"left",width:n.thumbnailWidth+"px",height:n.thumbnailHeight+"px",margin:n.thumbnailSpacing+"px"}).css(t).wrap(function(){return'<a class="lattice-grid-link" href="#'+s.data("row")+"-"+s.data("col")+'" ></a>'})}function A(e,t,r){if(!r){n.grid[e][t]=false;return}if(n.grid[e][t]===undefined){n.grid[e][t]={}}for(var i in r){if(r.hasOwnProperty(i)){n.grid[e][t][i]=r[i]}}}function O(e,t){e.append('<a class="lattice-adjacent-link" href="#'+t+'">'+n.html[t+"Arrow"]+"</a>")}function M(e){if(n.debug&&window.console&&window.console.log){console.log(e)}}var t=e(this);n.gridRows=b(t,"row");n.gridCols=b(t,"col");n.containerContext=t.context;t.css({position:"relative",width:n.sliderWidth,height:n.sliderHeight,overflow:"hidden"}).addClass(n.containerClass);t.children().css({"float":"left","list-style":"none",position:"absolute",height:"100%",width:"100%",display:"none"});if(n.fullScreen){C(this)}if(n.thumnailMapEnabled){e(n.html.thumbnailMap).appendTo("."+n.containerClass).width(function(){return(n.thumbnailWidth+2*n.thumbnailSpacing)*(n.gridCols+1)}).height(function(){return(n.thumbnailHeight+2*n.thumbnailSpacing)*(n.gridRows+1)})}for(var r=0;r<=n.gridRows;r++){n.grid[r]=[];for(var i=0;i<=n.gridCols;i++){var s=e("[data-row="+r+"][data-col="+i+"]"),o=i==n.gridCols?"right":"none";if(s.length==0){A(r,i,false);L({background:"none"},n.html.thumbnailEmpty,o,s);continue}L({"background-color":"#A7A1A1"},n.html.thumbnailDefault,o,s);A(r,i,{element:s,order:s.data("order"),html:e("<div>").append(s.clone()).html(),row:parseInt(s.data("row")),col:parseInt(s.data("col")),visited:false,north:false,south:false,east:false,west:false});if(s.data("travel")){var u=s.data("travel");e.each(u.split(","),function(e,t){n.grid[r][i][t]=true;O(s,t)});continue}for(direction in n.compassDict){if(n.compassDict.hasOwnProperty(direction)){var a="[data-row="+(r+n.compassDict[direction].offsetR)+"][data-col="+(i+n.compassDict[direction].offsetC)+"]";travelProp={};if(e(a).length!=0){travelProp[direction]=true;A(r,i,travelProp);O(s,direction)}else{travelProp[direction]=false;A(r,i,travelProp)}}}}}M(n);var f=t.find(n.startSelector);f.toggleClass("active");n.active.row=parseInt(f.data("row"));n.active.col=parseInt(f.data("col"));l(n.active.row,n.active.col);e("."+n.containerClass+" .active").show();d();h();e(window).resize(function(){if(n.fullScreen){C(n.containerContext)}});e(window).keyup(function(e){if(n.inMotion||n.keyDict[e.which]===undefined){return}M("KEYPRESS DETECTED: "+n.keyDict[e.which]);n.inMotion=true;var t=parseInt(e.which),r=n.keyDict[e.which];var i=[n.grid[n.active.row][n.active.col]],s=n.active.row+n.compassDict[r].offsetR,o=n.active.col+n.compassDict[r].offsetC;i[0].directionTaken=r;n.grid[s][o].directionTaken=r;i.push(n.grid[s][o]);M(i);m(i,false);return});e(".active").mouseenter(function(){p();v()});e(".active").mouseleave(function(){if(!e(".lattice-thumbnail-map").is(":hover")){d();h()}});e(".lattice-adjacent-link").click(function(t){t.preventDefault();if(n.inMotion)return;else n.inMotion=true;var r=e(this).attr("href"),i=[n.grid[n.active.row][n.active.col]];var s=r.replace("#","");i[0].directionTaken=s;switch(s){case"north":n.grid[n.active.row-1][n.active.col].directionTaken=s;i.push(n.grid[n.active.row-1][n.active.col]);break;case"east":n.grid[n.active.row][n.active.col+1].directionTaken=s;i.push(n.grid[n.active.row][n.active.col+1]);break;case"south":n.grid[n.active.row+1][n.active.col].directionTaken=s;i.push(n.grid[n.active.row+1][n.active.col]);break;case"west":n.grid[n.active.row][n.active.col-1].directionTaken=s;i.push(n.grid[n.active.row][n.active.col-1]);break;default:return;break}M(i);m(i,false);return});e(".lattice-grid-link").click(function(t){t.preventDefault();if(n.inMotion)return;else n.inMotion=true;var r=e(this).attr("href");r=r.replace("#","");var i=r.split("-");var s=w({row:n.active.row,col:n.active.col},n.grid[i[0]][i[1]],n.grid);m(s,true);return})});return this}})(jQuery)